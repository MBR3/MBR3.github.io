<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .question {
      margin-bottom: 40px;
    }
    .masked-sentence {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 20px;
    }
    .word-button {
      margin-right: 10px;
      margin-bottom: 10px;
      width: auto;
      flex-grow: 1;
    }
    .result {
      color: orange;
      margin-top: 10px;
      font-size: 24px;
      background-color: black;
      padding: 10px;
      border-radius: 5px;
    }
    #next-button {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div id="test-container"></div>
        <button id="next-button" class="btn btn-primary d-block mx-auto" style="display:none;">Next</button>
      </div>
    </div>
  </div>

  <script>
    // 問題データを定義
    var questions = [
      {"questionNumber": 1, "englishSentence": "Hi. I'm Christopher Green. Please call me Chris.", "japaneseTranslation": "やあ。私はクリストファー・グリーンです。私をクリスと読んでください。"},
      {"questionNumber": 2, "englishSentence": "\"Excuse me. Are you Mr. Parks?\" \"Yes, I am.\"", "japaneseTranslation": "「すいません。あなたはパークスさんですか？」「はい, そうです。」"},
      {"questionNumber": 3, "englishSentence": "\"Nice to meet you.\" \"Nice to meet you, too.\"", "japaneseTranslation": "「初めまして」「こちらこそよろしく」"},
      {"questionNumber": 4, "englishSentence": "\"How are you?\" \"Fine, thank you. And you?\"", "japaneseTranslation": "「元気ですか？」「元気です, ありがとう。あなたは？」"},
      {"questionNumber": 5, "englishSentence": "Good morning.", "japaneseTranslation": "おはよう。"},
      {"questionNumber": 6, "englishSentence": "Good afternoon.", "japaneseTranslation": "こんにちは。"},
      {"questionNumber": 7, "englishSentence": "Good evening.", "japaneseTranslation": "こんばんは。"}
    ];

    // 問題を生成して表示する関数
    function generateQuestion() {
      var testContainer = document.getElementById("test-container");
      var nextButton = document.getElementById("next-button");

      // すでに存在する問題があれば削除
      while (testContainer.firstChild) {
        testContainer.firstChild.remove();
      }

      // 問題をランダムに選択
      var question = questions[Math.floor(Math.random() * questions.length)];

      var questionDiv = document.createElement("div");
      questionDiv.classList.add("question");

      var questionNumber = document.createElement("h3");
      questionNumber.textContent = "Question " + question.questionNumber;

      var englishSentence = document.createElement("p");
      englishSentence.classList.add("fs-5");
      englishSentence.innerHTML = "<strong>English Sentence:</strong> " + question.englishSentence;

      var japaneseTranslation = document.createElement("p");
      japaneseTranslation.classList.add("fs-5");
      japaneseTranslation.innerHTML = "<strong>Japanese Translation:</strong> " + question.japaneseTranslation;

      var maskedSentence = document.createElement("p");
      maskedSentence.classList.add("masked-sentence");
      maskedSentence.innerHTML = "<strong>Masked Sentence:</strong> " + maskSentence(question.englishSentence);

      var result = document.createElement("p");
      result.classList.add("result");

      var shuffledWordsContainer = document.createElement("div");
      shuffledWordsContainer.classList.add("d-flex", "flex-wrap", "justify-content-center");

      var shuffledWords = shuffleWords(question.englishSentence);
      var remainingButtons = shuffledWords.length; // 追跡するボタンの数

      shuffledWords.forEach(function (word) {
        var button = document.createElement("button");
        button.className = "btn btn-primary word-button";
        button.textContent = word;
        button.addEventListener("click", function () {
          showSelectedWord(word, maskedSentence);
          button.style.display = "none"; // 選択したボタンを非表示にする
          remainingButtons--; // ボタンの数を減らす

          // すべてのボタンがクリックされたら
          if (remainingButtons === 0) {
            var maskedWithoutBrackets = maskedSentence.textContent.replace("Masked Sentence: ", "").replaceAll("(", "").replaceAll(")", ""); // 正規表現を調整
            if (maskedWithoutBrackets === question.englishSentence) {
              result.textContent = "Correct!";
              result.style.color = "orange";
            } else {
              result.textContent = "Incorrect!";
              result.style.color = "skyblue";
            }
            // 問題が終了したら、答えを表示し、「次へ」ボタンを表示
            questionDiv.appendChild(englishSentence);
            nextButton.style.display = "inline";
          }
        });
        shuffledWordsContainer.appendChild(button);
      });

      function showSelectedWord(word, maskedSentence) {
        maskedSentence.innerHTML = maskedSentence.innerHTML.replace(/\(  \)/, "(" + word + ")");
      }

      questionDiv.appendChild(questionNumber);
      questionDiv.appendChild(japaneseTranslation);
      questionDiv.appendChild(maskedSentence);
      questionDiv.appendChild(shuffledWordsContainer);
      questionDiv.appendChild(result);

      testContainer.appendChild(questionDiv);

      // 「次へ」ボタンが押されたら、新しい問題を生成
      nextButton.addEventListener("click", function () {
        nextButton.style.display = "none"; // 次の問題が生成されるまでボタンを非表示
        generateQuestion(); // 新しい問題を生成
      });
    }

    // 初期ロード時に問題を生成
    window.onload = generateQuestion;

    // 配列をシャッフルする関数
    function shuffleArray(array) {
      var currentIndex = array.length,
        temporaryValue, randomIndex;

      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

    // 文章内の単語をシャッフルする関数
    function shuffleWords(sentence) {
      var words = sentence.split(" ");
      return shuffleArray(words);
    }

    // 文章内の単語をマスクする関数
    function maskSentence(sentence) {
      var words = sentence.split(" ");
      var maskedWords = words.map(function (word) {
        if (word === ".") {
          return word; // ピリオドはマスクしない
        }
        return "(  )";
      });
      return maskedWords.join(" ");
    }
  </script>
  <!-- 別のhtmlで、しすたんの音声を聞いてディクテーションし、それを正誤判定するのも作りたい。 あとDUO3.0にも応用したい。-->
</body>
</html>
